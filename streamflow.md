# StreamCaster 配信プロセスフロー

## 概要

StreamCasterは、静止画または動画ファイルを複数のRTMPエンドポイントに同時配信するシステムです。配信は必ず静止画（スタンバイ画像）から開始され、その後動的にコンテンツを切り替えることができます。

## 配信開始プロセス

### 1. セッション初期化

配信セッションが開始されると、システムは必ず指定されたスタンバイ静止画から処理を開始します。この静止画は、FFmpegを使用して30秒のループ動画に自動変換されます。これにより、RTMPストリームに必要な連続的な映像データが確保されます。

### 2. プレイリスト作成

変換されたループ動画を含むプレイリストファイル（concat形式）が作成されます。このプレイリストは、FFmpegが読み込むコンテンツのリストとして機能し、シームレスなコンテンツ切り替えを可能にします。

### 3. FFmpegプロセス起動

単一のFFmpegプロセスが起動され、プレイリストを入力として読み込みます。このプロセスは、指定された2つのRTMPエンドポイントに対して同時に配信を行います。両方のエンドポイントには同じコンテンツが同じタイミングで送信されます。

## コンテンツ切り替えプロセス

### 動画ファイルへの切り替え

ユーザーが動画ファイルへの切り替えを要求すると、システムは以下の処理を実行します：

1. 指定された動画ファイルのパスを取得
2. プレイリストファイルを更新（新しい動画ファイルを追加）
3. FFmpegが自動的に新しいコンテンツを検出し、再生を開始

### 静止画への切り替え

静止画へ切り替える場合は、以下の処理が行われます：

1. 静止画を30秒のループ動画に変換
2. プレイリストファイルを更新
3. FFmpegが新しいループ動画の再生を開始

## 自動フォールバック機能

### ファイル終了時の処理

動画ファイルの再生が終了すると、システムは自動的にスタンバイ静止画に切り替わります。これにより、配信が途切れることなく継続されます。

### エラー発生時の処理

配信中にエラーが発生した場合、システムは以下の対応を行います：

1. **軽微なエラー**: 自動的に再接続を試行し、配信の継続を試みます
2. **致命的なエラー**: 配信を一時停止し、スタンバイ静止画での配信に切り替えます

## 技術的特徴

### 同時配信の仕組み

FFmpegは単一のプロセスで複数の出力を生成できる機能を活用しています。1つの入力ソース（プレイリスト）から、2つの独立したRTMPストリームを生成し、それぞれ異なるエンドポイントに送信します。この方式により、リソース効率的な配信が実現されています。

### プレイリストベースの配信

FFmpegの`-f concat`オプションを使用することで、複数のメディアファイルをシームレスに連結して配信できます。プレイリストファイルを動的に更新することで、配信を中断することなくコンテンツの切り替えが可能になっています。

### 状態管理

システムは各セッションの状態を詳細に管理し、現在配信中のコンテンツ、エラー状態、接続状況などを追跡します。これにより、適切なタイミングでの自動復旧やフォールバック処理が実現されています。

## セッション終了プロセス

配信セッションが終了すると、以下のクリーンアップ処理が実行されます：

1. FFmpegプロセスの正常終了
2. 一時ファイル（変換された動画、プレイリストなど）の削除
3. セッション情報のメモリからの削除
4. リソースの解放

この一連のプロセスにより、StreamCasterは安定した継続的な配信を実現しています。

## 配信プロセスフローチャート

```mermaid
flowchart TD
    A[セッション開始] --> B[スタンバイ静止画をループ動画に変換]
    B --> C[プレイリストファイル作成<br/>（スタンバイ動画のみ）]
    C --> D[FFmpegプロセス起動]
    D --> E[プレイリストベースストリーミング開始]
    E --> F{{"同時配信<br/>（1つの入力から2つの出力）"}}
    F --> F1[RTMPエンドポイント1]
    F --> F2[RTMPエンドポイント2]

    G[ファイル切り替えリクエスト] --> H{新しい入力は静止画？}
    H -->|Yes| I[静止画をループ動画に変換]
    H -->|No| J[動画ファイルをそのまま使用]
    I --> K[プレイリストファイル更新]
    J --> K
    K --> L[FFmpegが自動的に新しいコンテンツを読み込み]
    L --> F

    M[静止画に戻るリクエスト] --> N[スタンバイ画像をループ動画に変換]
    N --> K

    O[ファイル配信終了検知] --> P[自動的に静止画に切り替え]
    P --> N

    F1 --> Q1[配信状態監視]
    F2 --> Q2[配信状態監視]
    Q1 --> R{エラー発生？}
    Q2 --> R
    R -->|Yes| S{致命的エラー？}
    S -->|Yes| T[全配信停止・静止画に切り替え]
    S -->|No| U[再接続試行]
    T --> N
    U --> E

    V[セッション終了] --> W[FFmpegプロセス停止]
    W --> X[リソースクリーンアップ]
    X --> Y[セッション情報削
```
